<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>è§’è‰²æƒ…å¢ƒå¯¹è¯ - CP å±•ä¼šç‰ˆ</title>
    <meta name="description" content="ä¸æ¡ƒæ¡ƒå­å’Œä½©å¯å–µè¿›è¡Œæœ‰è¶£çš„å¯¹è¯ä½“éªŒ">
    <script src="api.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Comic Sans MS', cursive;
            background: linear-gradient(135deg, #ffb6c1 0%, #dda0dd 100%);
            min-height: 100vh; overflow-x: hidden;
        }
        .chat-container { display: flex; flex-direction: column; height: 100vh; max-width: 800px; margin: 0 auto; background: white; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .chat-header {
            background: linear-gradient(135deg, #ffb6c1 0%, #dda0dd 100%);
            color: white; padding: 1rem; display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .character-info { display: flex; align-items: center; gap: 0.75rem; }
        .character-avatar { width: 3rem; height: 3rem; border-radius: 50%; object-fit: cover; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .character-emoji { font-size: 2rem; width: 3rem; height: 3rem; display: flex; align-items: center; justify-content: center; background: white; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .character-details h2 { font-size: 1.25rem; margin-bottom: 0.25rem; }
        .character-details p { font-size: 0.875rem; opacity: 0.9; }
        .round-counter { background: rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: 9999px; font-size: 0.875rem; font-weight: bold; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 1rem; }
        .message { max-width: 80%; padding: 0.75rem 1rem; border-radius: 1rem; word-wrap: break-word; animation: messageSlide 0.3s ease-out; }
        @keyframes messageSlide { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message.user { background: #ffb6c1; color: white; align-self: flex-end; border-bottom-right-radius: 0.25rem; }
        .message.bot { background: #f3f4f6; color: #374151; align-self: flex-start; border-bottom-left-radius: 0.25rem; }
        .message-image { max-width: 200px; border-radius: 0.5rem; margin-top: 0.5rem; }
        .chat-input-container { padding: 1rem; background: white; border-top: 1px solid #e5e7eb; display: flex; gap: 0.5rem; align-items: flex-end; }
        .quick-buttons { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; flex-wrap: wrap; }
        .quick-btn { background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 9999px; padding: 0.25rem 0.75rem; font-size: 0.75rem; cursor: pointer; transition: all 0.2s ease; }
        .quick-btn:hover { background: #e5e7eb; }
        .input-group { display: flex; gap: 0.5rem; width: 100%; }
        .chat-input { flex: 1; border: 2px solid #d1d5db; border-radius: 9999px; padding: 0.75rem 1rem; font-size: 0.875rem; outline: none; transition: border-color 0.2s ease; }
        .chat-input:focus { border-color: #ffb6c1; }
        .send-btn, .image-btn { background: #ffb6c1; color: white; border: none; border-radius: 50%; width: 2.5rem; height: 2.5rem; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; font-size: 1rem; }
        .send-btn:hover, .image-btn:hover { background: #f472b6; transform: scale(1.05); }
        .send-btn:disabled, .image-btn:disabled { background: #d1d5db; cursor: not-allowed; transform: none; }
        .loading { display: none; align-items: center; gap: 0.5rem; color: #6b7280; font-size: 0.875rem; }
        .loading.show { display: flex; }
        .spinner { width: 1rem; height: 1rem; border: 2px solid #f3f3f3; border-top: 2px solid #ffb6c1; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: white; border-radius: 1rem; padding: 2rem; max-width: 400px; width: 90%; text-align: center; animation: modalSlide 0.3s ease-out; }
        @keyframes modalSlide { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .modal h3 { color: #dda0dd; margin-bottom: 1rem; font-size: 1.5rem; }
        .modal p { color: #6b7280; margin-bottom: 1.5rem; line-height: 1.5; }
        .modal-buttons { display: flex; gap: 1rem; justify-content: center; }
        .modal-btn { padding: 0.75rem 1.5rem; border: none; border-radius: 9999px; cursor: pointer; font-weight: bold; transition: all 0.2s ease; }
        .modal-btn.primary { background: #ffb6c1; color: white; }
        .modal-btn.secondary { background: #f3f4f6; color: #6b7280; }
        .modal-btn:hover { transform: scale(1.05); }
        .back-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem; border-radius: 50%; cursor: pointer; transition: all 0.2s ease; }
        .back-btn:hover { background: rgba(255,255,255,0.3); }
        @media (max-width: 768px) {
            .chat-container { height: 100vh; border-radius: 0; }
            .message { max-width: 90%; }
            .quick-buttons { justify-content: center; }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <button class="back-btn" onclick="goBack()" title="è¿”å›è§’è‰²é€‰æ‹©">â†</button>
            <div class="character-info">
                <img id="characterAvatar" class="character-avatar" src="" alt="" style="display: none;">
                <div id="characterEmoji" class="character-emoji" style="display: none;"></div>
                <div class="character-details">
                    <h2 id="characterName">é€‰æ‹©è§’è‰²</h2>
                    <p id="characterDesc">å¼€å§‹å¯¹è¯</p>
                </div>
            </div>
            <div class="round-counter">
                <span id="roundCounter">0/8</span>
            </div>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="message bot" id="welcomeMessage">
                <div id="welcomeText">æ¬¢è¿ï¼è¯·é€‰æ‹©è§’è‰²å¼€å§‹å¯¹è¯ï½</div>
            </div>
        </div>
        
        <div class="chat-input-container">
            <div class="quick-buttons">
                <button class="quick-btn" onclick="sendQuickMessage('é—®æ‰“å¡ç‚¹')">é—®æ‰“å¡ç‚¹</button>
                <button class="quick-btn" onclick="sendQuickMessage('ä»Šå¤©æ‹¿æ— æ–™äº†å—')">ä»Šå¤©æ‹¿æ— æ–™äº†å—</button>
            </div>
            <div class="input-group">
                <input type="text" class="chat-input" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." maxlength="20" onkeypress="handleKeyPress(event)">
                <button class="image-btn" onclick="openImageUpload()" id="imageBtn" title="ğŸ“· è®©æˆ‘çœ‹çœ‹ä½ ">ğŸ“·</button>
                <button class="send-btn" onclick="sendMessage()" id="sendBtn">â†’</button>
            </div>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <span>AIæ­£åœ¨æ€è€ƒ...</span>
            </div>
        </div>
    </div>
    
    <input type="file" id="imageUpload" accept="image/*" capture="environment" style="display: none;" onchange="handleImageUpload(event)">
    
    <div class="modal" id="freebieModal">
        <div class="modal-content">
            <h3 id="freebieTitle">ä»Šæ—¥æ— æ–™æç¤º</h3>
            <p id="freebieDescription">ä½ å¾—åˆ°ï¼šæ‰“å¡æ£’ï¼</p>
            <p id="freebieNote" style="font-size: 0.875rem; color: #9ca3af;">ä»¥ç°åœºå‘æ”¾ä¸ºå‡†ï¼Œå…ˆåˆ°å…ˆå¾—</p>
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="closeFreebieModal()">æˆ‘çŸ¥é“å•¦</button>
                <button class="modal-btn secondary" onclick="restartChat()">é‡æ¥ä¸€æ¬¡</button>
            </div>
        </div>
    </div>
    
    <script>
        let currentCharacter = null;
        let roundCount = 0;
        let imageRoundsUsed = 0;
        let isEnded = false;
        let isLoading = false;
        
        const characters = {
            momoko: {
                name: 'æ¡ƒæ¡ƒå­ (Momoko)',
                desc: 'è§‰é†’çš„è™šæ‹Ÿè§’è‰²ï¼ŒæŠ€æœ¯å®…èŒç³»å°‘å¥³',
                avatar: 'avatars/momoko.jpg',
                emoji: 'ğŸŒ¸',
                welcomeMessage: 'ä½ å¥½å‘€ï½æˆ‘æ˜¯æ¡ƒæ¡ƒå­ï¼ä»Šå¤©ä¹Ÿè¦åœ¨ç°å®ä¸–ç•Œä¸­æ¢ç´¢æ–°äº‹ç‰©å‘¢ï½æœ‰ä»€ä¹ˆæƒ³äº†è§£çš„å—ï¼Ÿ',
                farewellMessage: 'å…ˆèŠåˆ°è¿™å„¿å•¦ï½ç¥ä½ ä»Šå¤©æ”¶è·æ»¡æ»¡ï¼'
            },
            peke: {
                name: 'ä½©å¯å–µ',
                desc: 'æ¡ƒæ¡ƒå­åˆ¶é€ çš„æ™ºèƒ½å® ç‰©å°çŒ«',
                avatar: '',
                emoji: 'ğŸ±',
                welcomeMessage: 'å–µï½æˆ‘æ˜¯ä½©å¯å–µï¼è·Ÿç€ä¸»äººæ¡ƒæ¡ƒå­ä¸€èµ·æ¥æ¢ç´¢ç°å®ä¸–ç•Œå–µï½æœ‰ä»€ä¹ˆå¥½ç©çš„å—ï¼Ÿ',
                farewellMessage: 'æˆ‘è¦å»å·¡æ‘Šå•¦ï¼Œç•™ç‚¹æƒ³å¿µå–µï½'
            }
        };
        
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const character = urlParams.get('character');
            
            if (character && characters[character]) {
                selectCharacter(character);
            } else {
                window.location.href = 'index.html';
            }
        });
        
        function selectCharacter(characterId) {
            currentCharacter = characters[characterId];
            document.getElementById('characterName').textContent = currentCharacter.name;
            document.getElementById('characterDesc').textContent = currentCharacter.desc;
            
            if (currentCharacter.avatar) {
                const avatarImg = document.getElementById('characterAvatar');
                avatarImg.src = currentCharacter.avatar;
                avatarImg.alt = currentCharacter.name;
                avatarImg.style.display = 'block';
                avatarImg.onerror = function() {
                    this.style.display = 'none';
                    document.getElementById('characterEmoji').style.display = 'flex';
                };
            } else {
                document.getElementById('characterEmoji').textContent = currentCharacter.emoji;
                document.getElementById('characterEmoji').style.display = 'flex';
            }
            
            const welcomeMessage = document.getElementById('welcomeMessage');
            welcomeMessage.innerHTML = `<div>${currentCharacter.welcomeMessage}</div>`;
            
            roundCount = 0;
            imageRoundsUsed = 0;
            isEnded = false;
            updateRoundCounter();
        }
        
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || isLoading || isEnded) return;
            
            addMessage(message, 'user');
            input.value = '';
            simulateAIResponse(message);
        }
        
        function sendQuickMessage(message) {
            if (isLoading || isEnded) return;
            addMessage(message, 'user');
            simulateAIResponse(message);
        }
        
        function addMessage(content, type) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = `<div>${content}</div>`;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            if (type === 'user') {
                roundCount++;
                updateRoundCounter();
                
                if (roundCount >= 8) {
                    setTimeout(() => {
                        endConversation();
                    }, 1000);
                }
            }
        }
        
        async function simulateAIResponse(userMessage) {
            if (isLoading) return;
            
            isLoading = true;
            showLoading(true);
            
            try {
                const conversationHistory = getConversationHistory();
                const response = await window.apiClient.generateCharacterResponse(
                    currentCharacter.name.includes('æ¡ƒæ¡ƒå­') ? 'momoko' : 'peke',
                    userMessage,
                    conversationHistory
                );
                addMessage(response, 'bot');
            } catch (error) {
                console.error('APIè°ƒç”¨å¤±è´¥:', error);
                const response = generateAIResponse(userMessage);
                addMessage(response, 'bot');
            } finally {
                showLoading(false);
                isLoading = false;
            }
        }
        
        function generateAIResponse(userMessage) {
            const responses = {
                'é—®æ‰“å¡ç‚¹': 'å¯ä»¥å»é—®é—®å·¥ä½œäººå‘˜æˆ–è€…çœ‹çœ‹åœºåˆŠå–µï½',
                'ä»Šå¤©æ‹¿æ— æ–™äº†å—': 'æ—©ç‚¹å»é€›æ›´ç¨³å“¦ï½',
                'æ— æ–™': 'æ—©ç‚¹å»é€›æ›´ç¨³å“¦ï½',
                'æ‰“å¡': 'è®°å¾—æ‹ç…§ç•™å¿µå“¦ï½',
                'æ‹ç…§': 'ğŸ“· è®©æˆ‘çœ‹çœ‹ä½ ï¼',
                'ç»“æŸ': 'å¥½çš„ï¼Œé‚£æˆ‘ä»¬ä¸‹æ¬¡å†èŠï½'
            };
            
            for (const [key, response] of Object.entries(responses)) {
                if (userMessage.includes(key)) {
                    return currentCharacter.name.includes('æ¡ƒæ¡ƒå­') ? response : response.replace('å–µ', 'å–µï½');
                }
            }
            
            const defaultResponses = [
                'å¬èµ·æ¥å¾ˆæœ‰è¶£å‘¢ï½',
                'çœŸçš„å—ï¼Ÿå‘Šè¯‰æˆ‘æ›´å¤šå§ï¼',
                'å“‡ï¼Œå¥½å‰å®³ï¼',
                'æˆ‘ä¹Ÿæƒ³çŸ¥é“å‘¢ï½',
                'å¤ªæ£’äº†ï¼',
                'ç»§ç»­ç»§ç»­ï½'
            ];
            
            return currentCharacter.name.includes('æ¡ƒæ¡ƒå­') 
                ? defaultResponses[Math.floor(Math.random() * defaultResponses.length)]
                : defaultResponses[Math.floor(Math.random() * defaultResponses.length)] + 'å–µï½';
        }
        
        function openImageUpload() {
            if (isLoading || isEnded) return;
            
            if (imageRoundsUsed >= 3) {
                alert('å›¾ç‰‡åŠŸèƒ½å·²è¾¾ä¸Šé™ï¼Œä¸‹æ¬¡å†çœ‹ä½ ï½');
                return;
            }
            
            document.getElementById('imageUpload').click();
        }
        
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            addMessage('ğŸ“· è®©æˆ‘çœ‹çœ‹ä½ ', 'user');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const messagesContainer = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message user';
                messageDiv.innerHTML = `
                    <div>ğŸ“· è®©æˆ‘çœ‹çœ‹ä½ </div>
                    <img src="${e.target.result}" class="message-image" alt="ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡">
                `;
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            };
            reader.readAsDataURL(file);
            
            // è°ƒç”¨çœŸå®çš„å›¾ç‰‡ç†è§£API
            handleImageDescription(file);
            imageRoundsUsed++;
        }
        
        // çœŸå®çš„å›¾ç‰‡ç†è§£APIè°ƒç”¨
        async function handleImageDescription(file) {
            if (isLoading) return;
            
            isLoading = true;
            showLoading(true);
            
            try {
                // å‹ç¼©å›¾ç‰‡
                const compressedFile = await compressImage(file);
                
                // ä¸Šä¼ åˆ°ç¡¬ä»¶æ¥å£
                await uploadHardwareImage(compressedFile);
                
                // è°ƒç”¨å›¾ç‰‡æè¿°API
                const response = await describeImage();
                
                addMessage(response, 'bot');
            } catch (error) {
                console.error('å›¾ç‰‡ç†è§£å¤±è´¥:', error);
                // ä½¿ç”¨å¤‡ç”¨æè¿°
                const descriptions = [
                    'ç™½è‰²åœ¨ç¯å…‰é‡Œå¾ˆè½¯ï¼Œåƒå¥¶æ³¡ä¸€æ ·ï½',
                    'ç²‰è‰²æŠŠä½ åŒ…ä½å•¦ï¼Œç”œç”œçš„æ°”æ¯åœ¨å‘å…‰ï½',
                    'çœ‹èµ·æ¥å¥½æœ‰è¶£å‘¢ï¼',
                    'è¿™ä¸ªè§’åº¦æ‹å¾—çœŸä¸é”™ï½',
                    'å“‡ï¼Œå¥½æ¼‚äº®ï¼',
                    'å¤ªå¯çˆ±äº†ï½'
                ];
                
                const response = currentCharacter.name.includes('æ¡ƒæ¡ƒå­') 
                    ? descriptions[Math.floor(Math.random() * descriptions.length)]
                    : descriptions[Math.floor(Math.random() * descriptions.length)] + 'å–µï½';
                
                addMessage(response, 'bot');
            } finally {
                showLoading(false);
                isLoading = false;
            }
        }
        
        // æ¨¡æ‹Ÿå›¾ç‰‡æè¿°ï¼ˆå¤‡ç”¨ï¼‰
        function simulateImageDescription() {
            if (isLoading) return;
            
            isLoading = true;
            showLoading(true);
            
            setTimeout(() => {
                const descriptions = [
                    'ç™½è‰²åœ¨ç¯å…‰é‡Œå¾ˆè½¯ï¼Œåƒå¥¶æ³¡ä¸€æ ·ï½',
                    'ç²‰è‰²æŠŠä½ åŒ…ä½å•¦ï¼Œç”œç”œçš„æ°”æ¯åœ¨å‘å…‰ï½',
                    'çœ‹èµ·æ¥å¥½æœ‰è¶£å‘¢ï¼',
                    'è¿™ä¸ªè§’åº¦æ‹å¾—çœŸä¸é”™ï½',
                    'å“‡ï¼Œå¥½æ¼‚äº®ï¼',
                    'å¤ªå¯çˆ±äº†ï½'
                ];
                
                const response = currentCharacter.name.includes('æ¡ƒæ¡ƒå­') 
                    ? descriptions[Math.floor(Math.random() * descriptions.length)]
                    : descriptions[Math.floor(Math.random() * descriptions.length)] + 'å–µï½';
                
                addMessage(response, 'bot');
                showLoading(false);
                isLoading = false;
            }, 1500);
        }
        
        function endConversation() {
            if (isEnded) return;
            
            isEnded = true;
            addMessage(currentCharacter.farewellMessage, 'bot');
            
            setTimeout(() => {
                showFreebieModal();
            }, 1000);
        }
        
        function showFreebieModal() {
            const freebies = [
                { type: 'æ‰“å¡æ£’', title: 'ä»Šæ—¥æ— æ–™æç¤º', description: 'ä½ å¾—åˆ°ï¼šæ‰“å¡æ£’ï¼' },
                { type: 'è¢‹å­', title: 'ä»Šæ—¥æ— æ–™æç¤º', description: 'ä½ å¾—åˆ°ï¼šè¢‹å­ï¼' }
            ];
            
            const freebie = freebies[Math.floor(Math.random() * freebies.length)];
            
            document.getElementById('freebieTitle').textContent = freebie.title;
            document.getElementById('freebieDescription').textContent = freebie.description;
            document.getElementById('freebieModal').classList.add('show');
        }
        
        function closeFreebieModal() {
            document.getElementById('freebieModal').classList.remove('show');
        }
        
        function restartChat() {
            closeFreebieModal();
            window.location.href = 'index.html';
        }
        
        function goBack() {
            if (confirm('ç¡®å®šè¦è¿”å›è§’è‰²é€‰æ‹©å—ï¼Ÿå½“å‰å¯¹è¯å°†ä¸¢å¤±ã€‚')) {
                window.location.href = 'index.html';
            }
        }
        
        function updateRoundCounter() {
            document.getElementById('roundCounter').textContent = `${roundCount}/8`;
        }
        
        function showLoading(show) {
            const loading = document.getElementById('loading');
            const sendBtn = document.getElementById('sendBtn');
            const imageBtn = document.getElementById('imageBtn');
            
            if (show) {
                loading.classList.add('show');
                sendBtn.disabled = true;
                imageBtn.disabled = true;
            } else {
                loading.classList.remove('show');
                sendBtn.disabled = false;
                imageBtn.disabled = false;
            }
        }
        
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        function getConversationHistory() {
            const messages = document.querySelectorAll('.message');
            const history = [];
            
            messages.forEach(message => {
                const content = message.querySelector('div').textContent.trim();
                const isUser = message.classList.contains('user');
                
                if (content && !content.includes('ğŸ“· è®©æˆ‘çœ‹çœ‹ä½ ')) {
                    history.push({
                        role: isUser ? 'user' : 'assistant',
                        content: content
                    });
                }
            });
            
            return history;
        }
        
        // å›¾ç‰‡å‹ç¼©å‡½æ•°
        function compressImage(file) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // è®¡ç®—å‹ç¼©åçš„å°ºå¯¸ï¼ˆæœ€é•¿è¾¹640pxï¼‰
                    const maxSize = 640;
                    let { width, height } = img;
                    
                    if (width > height) {
                        if (width > maxSize) {
                            height = (height * maxSize) / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width = (width * maxSize) / height;
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // ç»˜åˆ¶å‹ç¼©åçš„å›¾ç‰‡
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // è½¬æ¢ä¸ºBlob
                    canvas.toBlob((blob) => {
                        resolve(blob);
                    }, 'image/jpeg', 0.7);
                };
                
                img.src = URL.createObjectURL(file);
            });
        }
        
        // ä¸Šä¼ å›¾ç‰‡åˆ°ç¡¬ä»¶æ¥å£
        async function uploadHardwareImage(file) {
            const base64 = await fileToBase64(file);
            const response = await fetch('https://6b2miwy3n5.ap-northeast-1.awsapprunner.com/api/v1/hardware/updateimage', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiI2OGI5NjYyYjljYzVlMjZmNjBjNTk1YTAiLCJ1c2VybmFtZSI6InRlc3R1c2VyX3Byb2R1Y3QiLCJleHAiOjE3NTk1NzI3Nzl9.iP6znTApaixpqVux5YAIHG6DCbU7Y-ocYQjMy9iP9l4'
                },
                body: JSON.stringify({
                    userid: '68b9662b9cc5e26f60c595a0',
                    deviceid: 'PC-LOCAL',
                    pic: base64
                })
            });
            
            if (!response.ok) {
                throw new Error(`ç¡¬ä»¶å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ${response.status}`);
            }
            
            return await response.json();
        }
        
        // ç”Ÿæˆå›¾ç‰‡æè¿°
        async function describeImage() {
            const response = await fetch('https://6b2miwy3n5.ap-northeast-1.awsapprunner.com/api/picture/describe', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiI2OGI5NjYyYjljYzVlMjZmNjBjNTk1YTAiLCJ1c2VybmFtZSI6InRlc3R1c2VyX3Byb2R1Y3QiLCJleHAiOjE3NTk1NzI3Nzl9.iP6znTApaixpqVux5YAIHG6DCbU7Y-ocYQjMy9iP9l4',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    character_id: '68b96da8d1cebe8b32c595a0',
                    user_name: 'ç”¨æˆ·',
                    prompt: 'è¯·ç”¨ä¸€å¥è¯æè¿°è¿™å¼ å›¾ç‰‡çš„è‰²å½©ä¸æ°›å›´ï¼Œä¸è¦ç»™å»ºè®®ã€‚'
                })
            });
            
            if (!response.ok) {
                throw new Error(`æè¿°ç”Ÿæˆå¤±è´¥: ${response.status}`);
            }
            
            const data = await response.json();
            return data.result || data.reply || 'å›¾ç‰‡çœ‹èµ·æ¥å¾ˆæœ‰è¶£å‘¢ï¼';
        }
        
        // æ–‡ä»¶è½¬Base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const result = reader.result;
                    const base64 = result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
    </script>
</body>
</html>